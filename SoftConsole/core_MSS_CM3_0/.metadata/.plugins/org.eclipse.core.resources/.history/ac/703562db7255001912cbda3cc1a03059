#include "drivers/mss_uart/mss_uart.h"

#define TFMINI_ADDR 0x10

#define MAX_MEASURMENT_ATTEMPTS 100

int measure()
{
	MSS_UART_init
		     (
		         &g_mss_uart1,
		         MSS_UART_115200_BAUD,
		         MSS_UART_DATA_8_BITS | MSS_UART_NO_PARITY | MSS_UART_ONE_STOP_BIT
		     );

	uint8_t setup_buffer[8] = {0x42, 0x57, 0x02, 0x00, 0x00, 0x00, 0x01, 0x06};

	int measurementAttempts = 0;

	while(measurementAttempts < MAX_MEASURMENT_ATTEMPTS){
		uint8_t rx_buff[9];

		// dummy reads
		while(MSS_UART_get_rx( &g_mss_uart1, rx_buff, sizeof(rx_buff) )){}

		MSS_UART_polled_tx( &g_mss_uart1, setup_buffer, sizeof(setup_buffer) );
		int rx_size = MSS_UART_get_rx( &g_mss_uart1, rx_buff, sizeof(rx_buff) ); // actual read

		char ready0, ready1;
		ready0 = rx_buff[0];
		ready1 = rx_buff[1];

		if(ready0 != 0x59 || ready1 != 0x59){
			// failed
			++measurementAttempts;

		}
		else{
			// success
			uint16_t distance = (rx_buff[3] << 8) + rx_buff[2];
			printf("%d", distance);
			measurementAttempts = 0;
		}
	}

}

int main(){


}
